<html>
    <head>
        <script src="https://cdn.kustomerapp.com/card-js/latest/kustomer-card.min.js"></script>
        <script>
            /**
             * Function to extract the parcelLabApiToken from the URL
             * @returns {string|null} The parcelLabApiToken value or null if not found
             */
            function getParcelLabApiToken() {
                const urlParams = new URLSearchParams(window.location.search);
                const parcelLabApiToken = urlParams.get('parcelLabApiToken');
                return parcelLabApiToken;
            }

            /**
             * Function to extract the email from the context JSON
             * @param {Object} contextJSON - The context JSON object
             * @returns {string|null} The email value or null if not found
             */
            function getEmailFromContext(contextJSON) {
                var customer_attributes = contextJSON.customer.attributes;
                if (customer_attributes.emails.length) {
                    return customer_attributes.emails[0].email;
                }
                return null;
            }

            function loadContext() {
                // Kustomer.initialize is required for card visibility in the panel.
                Kustomer.initialize(async function(contextJSON) {
                    const parcelLabApiToken = getParcelLabApiToken();
                    if (!parcelLabApiToken) {
                        Kustomer.updateStatus("error", "parcelLab API token not configured, go to settings page to set up");
                        return;
                    }

                    const email = getEmailFromContext(contextJSON);
                    if (!email) {
                        Kustomer.close();
                        return;
                    }

                    try {
                        const response = await Kustomer.command.run('parcellab_app_67d870cd1e9424e90dc47333.app.api.fetchOrderData', {
                            body: { "customerEmail": email},
                            headers: {
                                Authorization: "Bearer {{authToken}}"
                            }
                        })

                        // Fill the container with the formatted JSON data
                        document.getElementById('container').innerHTML = `<pre>${encodedJsonString}</pre>`;
                            
                        // Update the Kustomer status to show success
                        Kustomer.updateStatus("success", "Orders retrieved successfully");
                    } catch (error) {
                        Kustomer.updateStatus("error", "Error retrieving orders");
                    }
                });
            }
        </script>
    </head>
    <body onload="loadContext()">
        <div class="ui card mainCard">
            <div class="content">
                <div class="ui header cardHeader">
                    parcelLab
                </div>
            </div>
            <hr class="lineBreak">
            <div id="container" class="ui one textArea"></div>
        </div>
    </body>
</html>
